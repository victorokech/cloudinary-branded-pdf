<p align="center"><a href="https://cloudinary.com" target="_blank">			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 96.77" width="500" height="97" fill="blue">
				<path
					d="M160.53 30.41a17.14 17.14 0 0 1 13.56 6.7.69.69 0 0 0 1 .11l5.71-4.55a.71.71 0 0 0 .11-1 26 26 0 0 0-20.61-10.13c-14.91 0-27 12.85-27 28.65s12.13 28.65 27 28.65a25.85 25.85 0 0 0 20.6-10.12.69.69 0 0 0-.12-1l-5.7-4.5a.71.71 0 0 0-1 .11A17.26 17.26 0 0 1 160.53 70c-10.19 0-18.16-8.7-18.16-19.79s7.97-19.8 18.16-19.8ZM188.27 19.91h7.16a.71.71 0 0 1 .71.71V77.4a.7.7 0 0 1-.7.7h-7.16a.71.71 0 0 1-.71-.71V20.62a.7.7 0 0 1 .7-.71ZM220.54 39.55c-9.49 0-19.09 6.72-19.09 19.57 0 11.29 8.21 19.81 19.09 19.81s19.17-8.52 19.17-19.81-8.24-19.57-19.17-19.57Zm10.53 19.57c0 6.52-4.53 11.44-10.53 11.44s-10.44-4.92-10.44-11.44 4.49-11.2 10.44-11.2 10.53 4.81 10.53 11.2ZM278.3 40.37h-7.16a.7.7 0 0 0-.71.7v19c0 7.42-5.12 10.05-9.51 10.05-3.88 0-7.79-2.93-7.79-9.48V41.07a.7.7 0 0 0-.71-.7h-7.16a.7.7 0 0 0-.7.7v20.5c0 11.25 5.09 17.44 14.34 17.44 3.36 0 8.8-1.93 10.84-6.19l.69.14v4.44a.71.71 0 0 0 .71.71h7.16a.71.71 0 0 0 .71-.71V41.07a.7.7 0 0 0-.71-.7ZM322.27 19.91h-7.17a.7.7 0 0 0-.7.71V46l-.44-.7c-2.18-3.51-6.87-5.78-11.95-5.78-8.76 0-17.62 6.75-17.62 19.65 0 11.25 7.61 19.73 17.69 19.73 3.84 0 9.25-1.54 11.88-5.86l.44-.72v5.08a.7.7 0 0 0 .7.71h7.17a.7.7 0 0 0 .7-.71V20.62a.7.7 0 0 0-.7-.71Zm-8 39.21a11 11 0 0 1-10.75 11.36c-5.86 0-10.45-5-10.45-11.36s4.59-11.2 10.45-11.2a11 11 0 0 1 10.72 11.2ZM333 40.37h7.16a.7.7 0 0 1 .7.7V77.4a.7.7 0 0 1-.7.7H333a.71.71 0 0 1-.71-.71V41.07a.71.71 0 0 1 .71-.7ZM336.61 21.06a5.57 5.57 0 0 0-5.69 5.57 5.64 5.64 0 0 0 5.69 5.58 5.54 5.54 0 0 0 5.61-5.58 5.48 5.48 0 0 0-5.61-5.57ZM370.35 39.55c-3.14 0-8.72 1.69-10.85 6.19l-.69-.14v-4.53a.7.7 0 0 0-.71-.7h-7.16a.7.7 0 0 0-.7.7V77.4a.7.7 0 0 0 .7.71h7.16a.71.71 0 0 0 .71-.71v-19c0-7.36 5.12-10 9.51-10 3.88 0 7.79 2.91 7.79 9.4v19.6a.71.71 0 0 0 .71.71H384a.71.71 0 0 0 .71-.71V56.91c-.02-11.19-5.12-17.36-14.36-17.36ZM427.48 40.37h-7.16a.7.7 0 0 0-.71.7v5l-.43-.7c-2.19-3.51-6.88-5.78-12-5.78-8.75 0-17.62 6.75-17.62 19.65 0 11.25 7.61 19.73 17.7 19.73 3.83 0 9.24-1.54 11.88-5.86l.43-.72v5.01a.71.71 0 0 0 .71.71h7.16a.7.7 0 0 0 .7-.71V41.07a.7.7 0 0 0-.66-.7Zm-8 18.75a11 11 0 0 1-10.78 11.36c-5.86 0-10.44-5-10.44-11.36s4.58-11.2 10.44-11.2a11 11 0 0 1 10.76 11.2ZM460.15 40.5a13.66 13.66 0 0 0-5.14-1c-4.76 0-8.22 2.85-10 8.25l-.64-.09v-6.59a.7.7 0 0 0-.71-.7h-7.16a.7.7 0 0 0-.71.7V77.4a.71.71 0 0 0 .71.71h7.24a.7.7 0 0 0 .7-.71V65c0-14.8 5.91-17 9.44-17a11 11 0 0 1 4.33.9.72.72 0 0 0 .61 0 .7.7 0 0 0 .36-.48l1.42-7.11a.71.71 0 0 0-.45-.81ZM499.88 40.68a.69.69 0 0 0-.59-.31h-7.71a.72.72 0 0 0-.66.45L481.59 65l-9.42-24.18a.72.72 0 0 0-.66-.45h-7.86a.69.69 0 0 0-.58.31.7.7 0 0 0-.07.66l14 34.38-7.73 20.09a.71.71 0 0 0 .66 1h7.5a.69.69 0 0 0 .65-.45l21.86-55a.69.69 0 0 0-.06-.68ZM97.91 28.11A40.38 40.38 0 0 0 59.73 0 39.62 39.62 0 0 0 24.6 20.87a29.88 29.88 0 0 0-7.21 56.56l.75.34h.05v-8.5a22.29 22.29 0 0 1 9.29-41.16l2.1-.22.92-1.89A32.15 32.15 0 0 1 59.73 7.57a32.7 32.7 0 0 1 31.55 25l.72 2.86h3a18.53 18.53 0 0 1 18.15 18.46c0 7.05-4.07 12.82-11 15.74v8.06l.5-.16c11.14-3.65 18.06-12.71 18.06-23.64a26.19 26.19 0 0 0-22.8-25.78Z"></path>
				<path
					d="m45.07 76.79 1.66 1.66a.33.33 0 0 1-.23.56H33.4a6 6 0 0 1-6-6V47.57a.33.33 0 0 0-.33-.33h-2.8a.33.33 0 0 1-.24-.56l11.12-11.12a.33.33 0 0 1 .47 0l11.11 11.12a.33.33 0 0 1-.23.56h-2.84a.34.34 0 0 0-.34.33v25a6 6 0 0 0 1.75 4.22ZM69.64 76.79l1.67 1.66a.33.33 0 0 1-.24.56H58a6 6 0 0 1-6-6V54a.34.34 0 0 0-.33-.34h-2.83a.33.33 0 0 1-.23-.56L59.72 42a.33.33 0 0 1 .47 0l11.12 11.08a.33.33 0 0 1-.24.56h-2.84a.34.34 0 0 0-.33.34v18.59a6 6 0 0 0 1.74 4.22ZM94.22 76.79l1.66 1.66a.33.33 0 0 1-.23.56H82.54a6 6 0 0 1-6-6V60.38a.33.33 0 0 0-.33-.33h-2.8a.33.33 0 0 1-.23-.57L84.3 48.37a.32.32 0 0 1 .46 0l11.12 11.11a.33.33 0 0 1-.23.57H92.8a.33.33 0 0 0-.33.33v12.19a6 6 0 0 0 1.75 4.22Z"></path>
			</svg>
</a></p>

<h1 align="center">
 Generate a Watermarked Multi-paged PDF
</h1>

Cloudinary is a Software-as-a-Service (SaaS) solution for managing all your web or mobile application’s media assets in
the cloud. Cloudinary offers an end-to-end solution for all your image and video needs, including the upload, storage,
administration, transformation and optimized delivery.

Laravel is a PHP framework developed with developer productivity in mind. The framework also aims to evolve with the web
and has already incorporated several new features and ideas in the web development world—such as job queues, **API
authentication** out of the box, real-time communication, and much more.

## Introduction

One of the ways to present your work is to create a portfolio. In this article, we will create a PDF portfolio with your
branding from photos you upload to Cloudinary with a specific tag for instance "Wedding".

Let's get started.

## PHPSandbox and Github

The final project can be viewed on [PHPSandbox](https://phpsandbox.io/e/x/1uzuh?layout=EditorPreview&defaultPath=%2F&theme=dark&showExplorer=no&openedFiles=) and the entire source code is available on my [Github](https://github.com/victorokech/cloudinary-branded-pdf)repository.

## Prerequisites

Using Cloudinary in your Laravel projects is pretty straightforward. However, for you to be able to easily follow along,
you need to have a good command of your terminal, Git and entry knowledge of PHP specifically with the Laravel
framework.

## Getting Started

Being that Laravel is a PHP Framework, we will need Composer. Like any modern PHP framework, Laravel uses Composer to
manage its dependencies. Before, we can start ensure you have Composer installed on your machine. Follow step 1 below to
install Composer and PHP.

1. Install [Composer](https://getcomposer.org/) and [PHP](https://www.php.net/manual/en/install.windows.tools.php) on
   your development or production machine.
2. Install Laravel

   1. Via Composer:

      `composer create-project --prefer-dist laravel/laravel cloudinary-branded-pdf`
   2. Via Laravel Installer

      `composer global require laravel/installer`

      `laravel new cloudinary-branded-pdf`
3. In step 2 above we have installed the Laravel Installer and used it to scaffold a new application in the
   folder `cloudinary-branded-pdf`. With Laravel installed, we should be able to start and test the server ensuring
   everything is okay. Change the directory to the project folder and run the local development server by typing the
   following commands:

   `cd cloudinary-branded-pdf`

   `php artisan serve`

The Laravel project is now up and running. When you open `http://localhost:8000` on your computer, you should see the
image below:

![Laravel Server Running](https://res.cloudinary.com/dgrpkngjn/image/upload/c_scale,w_940/v1655976836/assets/laravel-running.png)

## Setting up Cloudinary’s Laravel SDK

We will be using Cloudinary to generate multi-paged PDFs from images we will tag and upload. We will also perform the
overlay transformation to add a watermark to each of the pages. Sounds fun, we will start by creating a
free [Cloudinary](https://cloudinary.com/) account.

1. Sign up for a free Cloudinary account then navigate to the Console page and take note of your Cloud name, API Key and
   API Secret.

   ![Cloudinary Dashboard](https://res.cloudinary.com/dgrpkngjn/image/upload/c_scale,w_940/v1655976836/assets/cloudinary_dashboard.png)
2. Install [Cloudinary’s Laravel SDK](https://github.com/cloudinary-labs/cloudinary-laravel#installation):

   `composer require cloudinary-labs/cloudinary-laravel`

**Note**: Please ensure you follow all the steps in the #Installation section. Publish the configuration file and add
the Cloudinary credentials you noted in Step 1 to the `.env` file.

```
CLOUDINARY_API_KEY=YOUR_CLOUDINARY_API_KEY
CLOUDINARY_API_SECRET=YOUR_CLOUDINARY_API_SECRET
CLOUDINARY_CLOUD_NAME=YOUR_CLOUDINARY_CLOUD_NAME
```

## Generating a Watermarked Multi-paged PDF

We will use Cloudinary's Upload API with the `multi` method which will take the images we upload, apply transformations
and convert them to a PDF document.

## Multiple File Upload with Livewire

To generate a PDF document we will need a user interface, we will use the Laravel package Livewire to build this.

1. Install Livewire Package by running the following command in your Laravel project:

   `composer require livewire/livewire`
2. Include Livewire scripts and styles on every page that will be using Livewire. In our case `welcome.blade.php`:

```html
...
@livewireStyles
</head>
<body>
...

@livewireScripts
</body>
</html>
```

3. We will then create a Livewire Component to handle our image uploads:

   `php artisan make:livewire MultipleFileUpload`

This will create two files, first `app/Http/Livewire/MultipleFileUpload.php` and the other one
in `resources/views/livewire/multiple-file-upload.blade.php`

Now you can use this component anywhere in your Laravel project using the following snippet:

`<livewire:multiple-file-upload/>`

or

`@livewire('multiple-file-upload')`

3. Open `resources/views/welcome.blade.php` and add the following code within the `<body></body>` tags as shown below:

```html

<body class="antialiased">
<div>
	@livewire('multiple-file-upload')
</div>
</body>
```

This includes the Livewire component we created earlier in our `welcome.blade.php`.

**Note:** Please ensure you go through the [Livewire documentation](https://laravel-livewire.com/docs/2.x/quickstart),
to learn how to install and set it up.

3. Open the file `resources/views/livewire/multiple-file-upload.blade.php` and populate it with the following code:

```html

<form class="mb-5" wire:submit.prevent="uploadImages">
	<div class="form-group row mt-5 mb-3">
		<div class="input-group mb-5">
			<input id="watermark" type="file" class="form-control @error('watermark') is-invalid @enderror"
			       placeholder="Choose files..." wire:model="watermark">
			<label class="input-group-text" for="media">
				Choose watermark...
			</label>
			@error('watermark')
			<div class="invalid-feedback">{{ $message }}</div>
			@enderror
		</div>
		<div class="input-group mb-3">
			<span class="input-group-text" id="basic-addon1">#</span>
			<input class="form-control @error('tag') is-invalid @enderror" placeholder="Portfolio Tag"
			       aria-label="Portfolio Tag"
			       aria-describedby="basic-addon1" wire:model="tag">
			@error('tag')
			<div class="invalid-feedback">{{ $message }}</div>
			@enderror
		</div>
		<div class="input-group">
			<input id="files" type="file" class="form-control @error('files'|'files.*') is-invalid @enderror"
			       placeholder="Choose files..." wire:model="files" multiple>
			<label class="input-group-text" for="files">
				Choose images for portfolio...
			</label>
		
			@error('files'|'files.*')
			<div class="invalid-feedback">{{ $message }}</div>
			@enderror
		</div>
		<small class="text-muted text-center mt-2" wire:loading wire:target="files">
			{{ __('Uploading') }}…
		</small>
		<small class="text-muted text-center mt-2" wire:loading wire:target="watermark">
			{{ __('Uploading') }}…
		</small>
	</div>
	<div class="text-center">
		<button type="submit" class="btn btn-sm btn-primary w-25">
			<i class="fas fa-check mr-1"></i> {{ __('Generate PDF') }}
			<i class="spinner-border spinner-border-sm ml-1 mt-1" wire:loading wire:target="uploadImages"></i>
		</button>
	</div>
</form>
```

This is our Livewire Component view, this basically will display a form with inputs for our watermark, tag, images
files and a button.

![Cloudinary PDF UI](https://res.cloudinary.com/dgrpkngjn/image/upload/c_scale,w_940/v1656858250/branded-pdf/assets/cloudinary_branded_pdf_action_fodyw0.png)

You will see the implementation in code shortly.

## Implementation in Code

Open the file `app/Http/Livewire/MultipleFileUpload.php`. Here, we are going to add a method that will handle the
multiple files selected by the user, upload them to Cloudinary and save their `public_id`'s in an array that we will use
later on.

Add the following code to this file.

1. First, we use Livewires `WithFileUploads` to help us with file uploads, then create two variables `$media`
   and `$optimizedImage` which is an array that will contain the image URLs we get back from Cloudinary.

   ```php
    		use WithFileUploads;

    		public $files = [];
    		public $watermark;
    		public $tag;
   ```
2. Secondly, we will create the `uploadImages` function which will upload the watermark and image files
   to [Cloudinary](https://cloudinary.com). Cloudinary will apply specific transformations to each one of the images
   that will make the pages before generating the PDF document.

   ```php
   public function uploadImages() {
    ...
   }
   ```
3. Let's populate our method in step 2 above:

   ```php
   public function uploadImages() {
    		$this->validate([
    			'files'     => [
    				'required',
    				'max:10240'
    			],
    			'files.*'   => 'mimes:jpeg,jpg,png',
    			'watermark' => [
    				'required',
    				'image',
    				'mimes:png',
    				'max:100'
    			],
    			'tag'       => [
    				'required',
    				'string',
    				'max:20'
    			],
    		]);

     $watermarkPublicId = cloudinary()->upload($this->watermark->getRealPath(), [
    			'folder'         => 'branded-pdf',
    			'public_id'      => 'watermark',
    		])->getPublicId();

      foreach ($this->files as $file) {
    			cloudinary()->upload($file->getRealPath(), [
    				'folder'  => 'branded-pdf',
    				'width'   => '794',
    				'height'  => '1123',
    				'gravity' => 'auto',
    				'crop'    => 'fill',
    				'tags'    => ["$this->tag"],
    			]);
    		}

    cloudinary()->uploadApi()->multi($this->tag, [
    			'transformation' => [
    				'overlay' => $watermarkPublicId,
    				'gravity' => 'north_east',
    				'x'       => 0.02,
    				'y'       => 0.02,
    				'crop'    => 'scale',
    				'flags'   => 'relative',
    				'width'   => 0.15,
    				'opacity' => 80
    			],
    			'format'           => 'pdf',
    			'notification_url' => env('CLOUDINARY_NOTIFICATION_URL')
    		]);
   }
   ```

   Let's talk about the code.

   - ### Uploading the watermark

     We upload the watermark to Cloudinary and get the `public_id` which we will use later on.


     ```php
     $watermarkPublicId = cloudinary()->upload($this->watermark->getRealPath(), [
     		'folder'         => 'branded-pdf',
     		'public_id'      => 'watermark',
     	])->getPublicId();
     ```
   - ### Uploading the images

     We upload the images selected by the user and apply the tag that they specified and some transformations to each one
     of them using a `for loop`.


     ```php
       foreach ($this->files as $file) {
       	cloudinary()->upload($file->getRealPath(), [
       		'folder'  => 'branded-pdf',
       		'width'   => '794',
       		'height'  => '1123',
       		'gravity' => 'auto',
       		'crop'    => 'fill',
       		'tags'    => ["$this->tag"],
       	]);
       }
     ```
   - ### The `multi` method

   Through the `Upload API`, the `multi` method allows us to apply transformations and generate the PDF from all the
   images with the `tag` that we pass to Cloudinary. We do this by specifying the `format` as `pdf` and applying the
   transformations which overlay our watermark on the images with this tag.

   ```php
     cloudinary()->uploadApi()->multi($this->tag, [
    	 'transformation' => [
    		 'overlay' => $watermarkPublicId,
    		 'gravity' => 'north_east',
    		 'x'       => 0.02,
    		 'y'       => 0.02,
    		 'crop'    => 'scale',
    		 'flags'   => 'relative',
    		 'width'   => 0.15,
    		 'opacity' => 80
    	 ],
    	 'format'           => 'pdf',
    	 'notification_url' => env('CLOUDINARY_NOTIFICATION_URL')
     ]);
   ```

You can check out the [reference](https://cloudinary.com/documentation/image_upload_api_reference#multi) for full
details on the relevant options.

On the `notification_url` we have specified we will receive a response from Cloudinary once our PDF has been
successfully created. The response will be as follows:

```json
{
	"url": "http://res.cloudinary.com/dgrpkngjn/image/multi/c_scale,fl_relative,g_north_east,l_branded-pdf:watermark,o_80,w_0.15,x_0.02,y_0.02/f_pdf/v1656857502/Wedding%20Photos.pdf",
	"secure_url": "https://res.cloudinary.com/dgrpkngjn/image/multi/c_scale,fl_relative,g_north_east,l_branded-pdf:watermark,o_80,w_0.15,x_0.02,y_0.02/f_pdf/v1656857502/Wedding%20Photos.pdf",
	"asset_id": "770deef5d2f1285e39565a1a77ebbe3d",
	"public_id": "Wedding Photos,pdf,c_scale,fl_relative,g_north_east,l_branded-pdf:watermark,o_80,w_0.15,x_0.02,y_0.02/f_pdf",
	"version": 1656857502,
	"notification_type": "multi"
}
```

**Tip:** Please be sure to change your Cloudinary settings to allow delivery of PDFs and ZIP files, this is disabled by
default to prevent dthe istribution of malware.

## Handling Cloudinary Responses

Webhooks are one of a few ways web applications can communicate with each other. We can receive Cloudinary's responses
through a webhook and run processes that will do something like notify the user or ban the video.

Create a `WebhookController.php` by typing the following command:

`php artisan make:controller WebhookController`

In the file created `app/Http/Controllers/WebhookController.php` we will add the following code:

```php
public function cloudinary(Request $request) {
  //Verification
  $verified = SignatureVerifier::verifyNotificationSignature(json_encode($request), $request->header('X-Cld-Timestamp'), $request->header('X-Cld-Signature'));

  // If the signature is verified and moderation is rejected
  if ($verified && $request->notification_type === 'multi') {
    // Get Secure URL
    $secureUrl = $request->secure_url;
    // Notify user
    ...
  }

  return response('Unverified', 401);
}
```

***Tip:*** A webhook is a mechanism where an application can notify another application that something has happened.

Since the notification from Cloudinary will be an external request we will need to allow it through
the `VerifyCsrfToken.php` middleware to prevent CSRF errors.

```php
...
  protected $except = [
    'webhooks'
  ];
}
```

Next, we will create the webhook route in `routes/api.php`.

```php
...
  //webhooks client
  Route::post('webhooks/cloudinary', [WebhookController::class, 'cloudinary']);
````

And finally update our `CLOUDINARY_NOTIFICATION_URL` in the environment variables file `.env` as follows:

```php
CLOUDINARY_NOTIFICATION_URL=https://<app_url>/api/webhooks/cloudinary
```

Finally, we can see the results:

![Cloudinary Watermarked PDF Created](https://res.cloudinary.com/dgrpkngjn/image/upload/c_scale,w_940/v1656857825/branded-pdf/assets/cloudinary_branded_pdf_success_foe1fn.png)

## Conclusion

Cloudinary makes it easy to generate a PDF by automating and applying some transformations. We can use this to create portfolios which we can then present to our clients.

The possibilities are endless, check out Cloudinary for your A to Z media management - upload, storage, administration,
manipulation, optimization and delivery.

[Get started](https://cloudinary.com/signup) with Cloudinary in your Laravel projects for FREE!
